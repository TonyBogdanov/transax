"use strict";var __awaiter=this&&this.__awaiter||function(t,r,a,l){return new(a=a||Promise)(function(s,i){function e(t){try{o(l.next(t))}catch(t){i(t)}}function n(t){try{o(l.throw(t))}catch(t){i(t)}}function o(t){var i;t.done?s(t.value):((i=t.value)instanceof a?i:new a(function(t){t(i)})).then(e,n)}o((l=l.apply(t,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Generator=exports.Options=void 0;const fs_1=require("fs"),path_1=require("path"),Logger_1=require("./Logger"),Analyzer_1=require("./Analyzer"),Compiler_1=require("./Compiler"),{readFile,writeFile}=fs_1.promises;class Options{constructor(t={}){this.translations={},this.loggerOptions={},this.analyzerOptions={},this.compilerOptions={},"translations"in t&&(this.translations=t.translations),"loggerOptions"in t&&(this.loggerOptions=t.loggerOptions),"analyzerOptions"in t&&(this.analyzerOptions=t.analyzerOptions),"compilerOptions"in t&&(this.compilerOptions=t.compilerOptions)}}exports.Options=Options;class Generator{constructor(t={}){this.keys={},this.options=t instanceof Options?t:new Options(t),this.logger=new Logger_1.Logger("Generator",this.options.loggerOptions),this.analyzer=new Analyzer_1.Analyzer(this.options.analyzerOptions),this.compiler=new Compiler_1.Compiler(this.options.compilerOptions)}parseContent(s,e){return __awaiter(this,void 0,void 0,function*(){for(const i of this.analyzer.analyze(s,e?(0,path_1.relative)(process.cwd(),e):void 0)){this.keys.hasOwnProperty(i.key)||(this.keys[i.key]=[]);var t=this.keys[i.key];const e=`${i.source||"[inline code]"}::${i.line}:`+i.column;t.includes(i.source)||t.push(e)}return this})}parseFile(t){return __awaiter(this,void 0,void 0,function*(){return yield this.parseContent((yield readFile(t)).toString("utf-8"),t),this})}getMissingTranslationKeys(){var t={};for(const i of Object.keys(this.options.translations)){const s=this.options.translations[i];t[i]=Object.keys(this.keys).filter(t=>!s.hasOwnProperty(t))}return t}getUnusedTranslationKeys(){var t={};for(const s of Object.keys(this.options.translations)){var i=this.options.translations[s];t[s]=Object.keys(i).filter(t=>!this.keys.hasOwnProperty(t))}return t}getCompiledTranslationsDump(){var t=t=>t.match(/^[a-z_$][a-z0-9_$]*$/i)?t:JSON.stringify(t);let i=`{
`;for(const s of Object.keys(this.options.translations)){const e=this.options.translations[s];i+=`    ${t(s)}: {
`;for(const n of Object.keys(this.keys).filter(t=>e.hasOwnProperty(t)))i+=`        ${t(n)}: ${this.compiler.compile(e[n])},
`;i+=`    },
`}return i+"}"}getCompiledTranslationsDumpAsCJSExport(){return`module.exports = ${this.getCompiledTranslationsDump()};
`}getCompiledTranslationsDumpAsESMExport(){return`export default ${this.getCompiledTranslationsDump()};
`}dumpMissingTranslationKeysAsJSON(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,JSON.stringify(this.getMissingTranslationKeys(),null,2))})}dumpUnusedTranslationKeysAsJSON(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,JSON.stringify(this.getUnusedTranslationKeys(),null,2))})}dumpCompiledTranslationsForCJS(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,this.getCompiledTranslationsDumpAsCJSExport())})}dumpCompiledTranslationsForESM(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,this.getCompiledTranslationsDumpAsESMExport())})}}exports.Generator=Generator;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Analyzer=exports.Options=exports.Token=void 0;const Logger_1=require("./Logger");function peg$padEnd(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}class PeggySyntaxError extends Error{static buildMessage(t,e){function r(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function s(t){switch(t.type){case"literal":return'"'+n(t.text)+'"';case"class":var e=t.parts.map(t=>Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t));return"["+(t.inverted?"^":"")+e+"]";case"any":return"any character";case"end":return"end of input";case"other":return t.description}}return"Expected "+function(t){var e=t.map(s);let r,n;if(e.sort(),0<e.length){for(r=1,n=1;r<e.length;r++)e[r-1]!==e[r]&&(e[n]=e[r],n++);e.length=n}switch(e.length){case 1:return e[0];case 2:return e[0]+" or "+e[1];default:return e.slice(0,-1).join(", ")+", or "+e[e.length-1]}}(t)+" but "+((t=e)?'"'+n(t)+'"':"end of input")+" found."}constructor(t,e,r,n){super(),this.message=t,this.expected=e,this.found=r,this.location=n,this.name="PeggySyntaxError","function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(this,PeggySyntaxError.prototype):this.__proto__=PeggySyntaxError.prototype,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,PeggySyntaxError)}format(r){let n="Error: "+this.message;if(this.location){let t=null,e;for(e=0;e<r.length;e++)if(r[e].grammarSource===this.location.source){t=r[e].text.split(/\r\n|\n|\r/g);break}var o,s,a,c=this.location.start,i=this.location.source+":"+c.line+":"+c.column;t?(a=this.location.end,o=peg$padEnd("",c.line.toString().length," "),s=t[c.line-1],a=c.line===a.line?a.column:s.length+1,n+="\n --\x3e "+i+"\n"+o+" |\n"+c.line+" | "+s+"\n"+o+" | "+peg$padEnd("",c.column-1," ")+peg$padEnd("",a-c.column,"^")):n+="\n at "+i}return n}}function peg$parse(a,t){const c={},L=(t=void 0!==t?t:{}).grammarSource;var e={Start:at};let r=at;function R(t){return t.map(t=>"\\'"===t?t[1]:t).join("")}function M(t){return t.map(t=>'\\"'===t?t[1]:t).join("")}function q(t){return t.map(([,t])=>"\\`"===t?t[1]:t).join("")}const U=function(t){return t.flat().filter(t=>t instanceof Token)},B="(",D=P("(",!1),G=/^[,)]/,H=F([",",")"],!1,!1),I=function(t,e){return new Token(t,e,rt(),nt().start.line,nt().start.column)},n=/^[ \t\r\n]/,o=F([" ","\t","\r","\n"],!1,!1),J=/^[^a-zA-Z_$]/,K=F([["a","z"],["A","Z"],"_","$"],!0,!1),N={type:"any"},Q=/^[a-zA-Z_$]/,V=F([["a","z"],["A","Z"],"_","$"],!1,!1),s=/^[a-zA-Z_$0-9]/,i=F([["a","z"],["A","Z"],"_","$",["0","9"]],!1,!1),W=rt,l="'",u=P("'",!1),p="\\'",h=P("\\'",!1),g=/^[^']/,f=F(["'"],!0,!1),A='"',d=P('"',!1),m='\\"',x=P('\\"',!1),y=/^[^"]/,$=F(['"'],!0,!1),b="`",E=P("`",!1),O="${",X=P("${",!1),v="\\`",Y=P("\\`",!1),tt=/^[^`]/,et=F(["`"],!0,!1);let S=0,_=0;const k=[{line:1,column:1}];let z=0,C=[],w=0;if(void 0!==t.startRule){if(!(t.startRule in e))throw new Error("Can't start parsing from rule \""+t.startRule+'".');r=e[t.startRule]}function rt(){return a.substring(_,S)}function nt(){return T(_,S)}function P(t,e){return{type:"literal",text:t,ignoreCase:e}}function F(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function ot(t){var e=k[t];let r;if(e)return e;for(r=t-1;!k[r];)r--;for(e={line:(e=k[r]).line,column:e.column};r<t;)10===a.charCodeAt(r)?(e.line++,e.column=1):e.column++,r++;return k[t]=e}function T(t,e){var r=ot(t),n=ot(e);return{source:L,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function j(t){S<z||(S>z&&(z=S,C=[]),C.push(t))}function st(t,e,r){return new PeggySyntaxError(PeggySyntaxError.buildMessage(t,e),t,e,r)}function at(){let t,e,r,n,o;for(t=S,e=[],r=S,(n=it())===c&&(n=null),(r=n!==c&&(o=ct())!==c?n=[n,o]:(S=r,c))===c&&(r=lt());r!==c;)e.push(r),r=S,(n=it())===c&&(n=null),(r=n!==c&&(o=ct())!==c?n=[n,o]:(S=r,c))===c&&(r=lt());return e!==c&&(_=t,e=U(e)),e}function ct(){let t,e,r,n,o;return t=S,e=function(){let t,e,r,n;t=S,Q.test(a.charAt(S))?(e=a.charAt(S),S++):(e=c,0===w&&j(V));if(e!==c){for(r=[],s.test(a.charAt(S))?(n=a.charAt(S),S++):(n=c,0===w&&j(i));n!==c;)r.push(n),s.test(a.charAt(S))?(n=a.charAt(S),S++):(n=c,0===w&&j(i));t=r!==c?(_=t,e=W()):(S=t,c)}else S=t,t=c;return t}(),t=e!==c&&Z()!==c&&(40===a.charCodeAt(S)?(r=B,S++):(r=c,0===w&&j(D)),r!==c)&&Z()!==c&&(n=function(){let t,e,r,n,o,s;t=S,39===a.charCodeAt(S)?(e=l,S++):(e=c,0===w&&j(u));if(e!==c){for(r=[],a.substr(S,2)===p?(n=p,S+=2):(n=c,0===w&&j(h)),n===c&&(g.test(a.charAt(S))?(n=a.charAt(S),S++):(n=c,0===w&&j(f)));n!==c;)r.push(n),a.substr(S,2)===p?(n=p,S+=2):(n=c,0===w&&j(h)),n===c&&(g.test(a.charAt(S))?(n=a.charAt(S),S++):(n=c,0===w&&j(f)));t=r!==c&&(39===a.charCodeAt(S)?(n=l,S++):(n=c,0===w&&j(u)),n!==c)?(_=t,e=R(r)):(S=t,c)}else S=t,t=c;if(t===c){if(t=S,34===a.charCodeAt(S)?(e=A,S++):(e=c,0===w&&j(d)),e!==c){for(r=[],a.substr(S,2)===m?(n=m,S+=2):(n=c,0===w&&j(x)),n===c&&(y.test(a.charAt(S))?(n=a.charAt(S),S++):(n=c,0===w&&j($)));n!==c;)r.push(n),a.substr(S,2)===m?(n=m,S+=2):(n=c,0===w&&j(x)),n===c&&(y.test(a.charAt(S))?(n=a.charAt(S),S++):(n=c,0===w&&j($)));t=r!==c&&(34===a.charCodeAt(S)?(n=A,S++):(n=c,0===w&&j(d)),n!==c)?(_=t,e=M(r)):(S=t,c)}else S=t,t=c;if(t===c)if(t=S,96===a.charCodeAt(S)?(e=b,S++):(e=c,0===w&&j(E)),e!==c){for(r=[],n=S,o=S,w++,a.substr(S,2)===O?(s=O,S+=2):(s=c,0===w&&j(X)),w--,o=s===c?void 0:(S=o,c),n=o!==c&&(a.substr(S,2)===v?(s=v,S+=2):(s=c,0===w&&j(Y)),s===c&&(tt.test(a.charAt(S))?(s=a.charAt(S),S++):(s=c,0===w&&j(et))),s!==c)?o=[o,s]:(S=n,c);n!==c;)r.push(n),n=S,o=S,w++,a.substr(S,2)===O?(s=O,S+=2):(s=c,0===w&&j(X)),w--,o=s===c?void 0:(S=o,c),n=o!==c&&(a.substr(S,2)===v?(s=v,S+=2):(s=c,0===w&&j(Y)),s===c&&(tt.test(a.charAt(S))?(s=a.charAt(S),S++):(s=c,0===w&&j(et))),s!==c)?o=[o,s]:(S=n,c);t=r!==c&&(96===a.charCodeAt(S)?(n=b,S++):(n=c,0===w&&j(E)),n!==c)?(_=t,e=q(r)):(S=t,c)}else S=t,t=c}return t}())!==c&&Z()!==c&&(G.test(a.charAt(S))?(o=a.charAt(S),S++):(o=c,0===w&&j(H)),o!==c)?(_=t,I(e,n)):(S=t,c)}function Z(){let t,e;for(t=[],n.test(a.charAt(S))?(e=a.charAt(S),S++):(e=c,0===w&&j(o));e!==c;)t.push(e),n.test(a.charAt(S))?(e=a.charAt(S),S++):(e=c,0===w&&j(o));return t}function it(){let t;return J.test(a.charAt(S))?(t=a.charAt(S),S++):(t=c,0===w&&j(K)),t}function lt(){let t;return a.length>S?(t=a.charAt(S),S++):(t=c,0===w&&j(N)),t}if((e=r())!==c&&S===a.length)return e;throw e!==c&&S<a.length&&j({type:"end"}),st(C,z<a.length?a.charAt(z):null,z<a.length?T(z,z+1):T(z,z))}const parse=peg$parse;class Token{constructor(t,e,r,n,o,s){this.name=t,this.key=e,this.text=r,this.line=n,this.column=o,this.source=s}}exports.Token=Token;class Options{constructor(t={}){this.names=["$t"],this.loggerOptions={},"names"in t&&(this.names=t.names),"loggerOptions"in t&&(this.loggerOptions=t.loggerOptions)}}exports.Options=Options;class Analyzer{constructor(t={}){this.options=t instanceof Options?t:new Options(t),this.logger=new Logger_1.Logger("Analyzer",this.options.loggerOptions)}skip(t,e){this.logger.verbose(`Skipping ${t.text} because: "${t.name}" isn't in the list of allowed names `+(e?`in: ${e}::${t.line}:${t.column}.`:`at: ${t.line}:${t.column}.`))}analyze(t,e){this.logger.log(`Analyzing: ${e||"[inline code]"}.`);var r=[];for(const n of parse(t))-1===this.options.names.indexOf(n.name)?this.skip(n,e):(n.source=e,r.push(n));return r}}exports.Analyzer=Analyzer;
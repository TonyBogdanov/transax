"use strict";var __awaiter=this&&this.__awaiter||function(e,a,u,l){return new(u=u||Promise)(function(r,t){function n(e){try{o(l.next(e))}catch(e){t(e)}}function i(e){try{o(l.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(n,i)}o((l=l.apply(e,a||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const node_path_1=require("node:path"),promises_1=require("node:fs/promises"),chokidar_1=require("chokidar"),glob_1=require("glob"),PathError_1=require("../../Util/PathError.cjs"),Generator_1=require("../../Generator/Generator.cjs"),Analyzer_1=require("../../Analyzer/Analyzer.cjs"),Compiler_1=require("../../Compiler/Compiler.cjs"),VitePluginOptions_1=require("./VitePluginOptions.cjs");function filename(e){return(e=(0,node_path_1.basename)(e)).substring(0,e.length-(0,node_path_1.extname)(e).length)}function flatten(e,t=[]){var r,n,i={};for([r,n]of Object.entries(e))"object"==typeof n?Object.assign(i,flatten(n,t.concat(r))):i[t.concat(r).join(".")]=n;return i}function createWatcher(e){return(0,chokidar_1.watch)(e,{ignoreInitial:!0,awaitWriteFinish:{stabilityThreshold:500}})}function createDumper(r,n){let e=null;return()=>new Promise(t=>{clearTimeout(e),e=setTimeout(()=>{var e;return Promise.all([n.output.compiled.handler(n.output.compiled.path,r),null!=(e=null==(e=n.output.missing)?void 0:e.handler(n.output.missing.path,r))?e:Promise.resolve(),null!=(e=null==(e=n.output.unused)?void 0:e.handler(n.output.unused.path,r))?e:Promise.resolve()]).then(()=>t())},500)})}function createDictionaryLoader(r,n,i){return t=>__awaiter(this,void 0,void 0,function*(){var e=yield n.dictionary.handler(t);return r.mergeTranslations(Object.fromEntries(Object.entries(e).map(e=>[e[0],flatten(e[1])]))),i()})}function createDictionaryRemover(t,r){return e=>__awaiter(this,void 0,void 0,function*(){return t.removeTranslations(filename(e)),r()})}function createInputLoader(t,r){return e=>__awaiter(this,void 0,void 0,function*(){return t.parse(yield(0,promises_1.readFile)(e,"utf8"),e),r()})}function createInputRemover(t,r){return e=>__awaiter(this,void 0,void 0,function*(){return t.parse("",e),r()})}function createMultiLoader(t){return e=>__awaiter(this,void 0,void 0,function*(){return Promise.all(e.map(t))})}function VitePlugin(e){const t=PathError_1.default.wrap("options",()=>new VitePluginOptions_1.default(e));var r={quiet:t.quiet,verbose:t.verbose},r=new Generator_1.default({analyzer:new Analyzer_1.default({names:t.input.keywords,keyFormatter:t.input.keyFormatter,logger:r}),compiler:new Compiler_1.default({logger:r}),logger:r}),n=createDumper(r,t);const i=createDictionaryLoader(r,t,n),o=createMultiLoader(i),a=createDictionaryRemover(r,n),u=createInputLoader(r,n),l=createMultiLoader(u),c=createInputRemover(r,n),s=createWatcher(t.input.pattern),d=createWatcher(t.dictionary.pattern);return{name:"vite-plugin-transax",buildStart(){d.on("add",i),d.on("change",i),d.on("unlink",a),s.on("add",u),s.on("change",u),s.on("unlink",c),(0,glob_1.glob)(t.dictionary.pattern).then(o),(0,glob_1.glob)(t.input.pattern).then(l)},closeBundle(){return Promise.all([s.close(),d.close()])}}}exports.default=VitePlugin;
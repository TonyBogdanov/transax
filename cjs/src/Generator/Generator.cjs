"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Analyzer_1=require("../Analyzer/Analyzer"),Compiler_1=require("../Compiler/Compiler"),Logger_1=require("../Logger/Logger");class Options{constructor(t={}){var e;this.translations=null!=(e=t.translations)?e:{},this.analyzer=null!=(e=t.analyzer)?e:new Analyzer_1.default,this.compiler=null!=(e=t.compiler)?e:new Compiler_1.default,this.logger=null!=(e=t.logger)?e:new Logger_1.default({namespace:"TRANSAX:GENERATOR"})}}class Generator{getDeduplicationDump(e){if(0===Object.keys(e).length)return"";let s="const ";for(let t=0;t<e.length;t++)s+=(0<t?"      ":"")+this.getDeduplicationVar(t)+" = "+e[t]+",\n";return s.substring(0,s.length-2)+";\n\n"}getDeduplicationVar(t){let e="";for(;e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"[t%52]+e,0<(t=Math.floor(t/52)););return"_"+e}constructor(t={}){this.keys={},this.options=new Options(t)}parse(t,e,s=!1){if(!s&&e)for(var[r,n]of Object.entries(this.keys))this.keys[r]=n.filter(t=>t.split("::")[0]!==e),0===this.keys[r].length&&delete this.keys[r];for(const i of this.options.analyzer.analyze(t,e)){this.keys.hasOwnProperty(i.key)||(this.keys[i.key]=[]);var o=this.keys[i.key];const e=`${i.source||"[inline code]"}::${i.line}:`+i.column;o.includes(i.source)||o.push(e)}return this}setTranslations(t,e){return this.options.translations[t]=e,this}removeTranslations(t){return this.options.translations.hasOwnProperty(t)&&delete this.options.translations[t],this}getMissingTranslationKeys(){var t={};for(const e of Object.keys(this.options.translations)){const s=this.options.translations[e];t[e]=Object.keys(this.keys).filter(t=>!s.hasOwnProperty(t))}return t}getUnusedTranslationKeys(){var t={};for(const s of Object.keys(this.options.translations)){var e=this.options.translations[s];t[s]=Object.keys(e).filter(t=>!this.keys.hasOwnProperty(t))}return t}getCompiledTranslationsDump(t,o){const i={};var e=Object.fromEntries(Object.keys(this.options.translations).map(t=>{const e=this.options.translations[t];var s={};for(const n of Object.keys(this.keys).filter(t=>e.hasOwnProperty(t))){var r=this.options.compiler.compile(e[n]);s[n]=r,o&&(i.hasOwnProperty(r)||(i[r]=0),i[r]++)}return[t,s]}));if(o){o.push(...Object.keys(i).filter(t=>1<i[t]));for(var[s,r]of Object.entries(e))for(var[n,a]of Object.entries(r)){a=o.indexOf(a);-1!==a&&(e[s][n]=this.getDeduplicationVar(a))}}var l,p,h=t=>t.match(/^[a-z_$][a-z0-9_$]*$/i)?t:JSON.stringify(t);let u=`{
`;for([l,p]of Object.entries(e)){u+=`    ${h(l)}: {
`;for(var[c,y]of Object.entries(p))t&&("{\n"!==u.slice(-2)&&(u+="\n"),this.keys[c].forEach(t=>u+=`        // ${t}
`)),u+=`        ${h(c)}: ${y},
`;u+=`    },
`}return u+"}"}getCompiledTranslationsDumpAsCJSExport(t){var e=[],t=`module.exports = ${this.getCompiledTranslationsDump(t,e)};
`;return this.getDeduplicationDump(e)+t}getCompiledTranslationsDumpAsESMExport(t){var e=[],t=`export default ${this.getCompiledTranslationsDump(t,e)};
`;return this.getDeduplicationDump(e)+t}}exports.default=Generator;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const crc_32_1=require("crc-32"),Analyzer_1=require("../Analyzer/Analyzer.cjs"),Compiler_1=require("../Compiler/Compiler.cjs"),Logger_1=require("../Logger/Logger.cjs");class Options{constructor(t={}){var e;this.translations=null!=(e=t.translations)?e:{},this.analyzer=null!=(e=t.analyzer)?e:new Analyzer_1.default,this.compiler=null!=(e=t.compiler)?e:new Compiler_1.default,this.logger=null!=(e=t.logger)?e:new Logger_1.default({namespace:"TRANSAX:GENERATOR"})}}class Generator{getDeduplicationDump(e){if(0===Object.keys(e).length)return"";let s="const ";for(let t=0;t<e.length;t++)s+=(0<t?"      ":"")+this.getDeduplicationVar(t)+" = "+e[t]+",\n";return s.substring(0,s.length-2)+";\n\n"}getDeduplicationVar(t){let e="";for(;e="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"[t%52]+e,0<(t=Math.floor(t/52)););return"_"+e}constructor(t={}){this.keys={},this.options=new Options(t)}parse(t,e,s=!1){if(!s&&e)for(var[r,n]of Object.entries(this.keys))this.keys[r]=n.filter(t=>t.split("::")[0]!==e),0===this.keys[r].length&&delete this.keys[r];for(const o of this.options.analyzer.analyze(t,e)){this.keys.hasOwnProperty(o.key)||(this.keys[o.key]=[]);var i=this.keys[o.key];const e=`${o.source||"[inline code]"}::${o.line}:`+o.column;i.includes(o.source)||i.push(e)}return this}setTranslations(t,e){return this.options.translations[t]=e,this}removeTranslations(t){return this.options.translations.hasOwnProperty(t)&&delete this.options.translations[t],this}getTranslationsChecksum(){return(0,crc_32_1.str)(JSON.stringify(this.options.translations))}getMissingTranslationKeys(){var t={};for(const e of Object.keys(this.options.translations)){const s=this.options.translations[e];t[e]=Object.keys(this.keys).filter(t=>!s.hasOwnProperty(t))}return t}getUnusedTranslationKeys(){var t={};for(const s of Object.keys(this.options.translations)){var e=this.options.translations[s];t[s]=Object.keys(e).filter(t=>!this.keys.hasOwnProperty(t))}return t}getCompiledTranslationsDump(t,i){const o={};var e=Object.fromEntries(Object.keys(this.options.translations).map(t=>{const e=this.options.translations[t];var s={};for(const n of Object.keys(this.keys).filter(t=>e.hasOwnProperty(t))){var r=this.options.compiler.compile(e[n]);s[n]=r,i&&(o.hasOwnProperty(r)||(o[r]=0),o[r]++)}return[t,s]}));if(i){i.push(...Object.keys(o).filter(t=>1<o[t]));for(var[s,r]of Object.entries(e))for(var[n,a]of Object.entries(r)){a=i.indexOf(a);-1!==a&&(e[s][n]=this.getDeduplicationVar(a))}}var l,c,p=t=>t.match(/^[a-z_$][a-z0-9_$]*$/i)?t:JSON.stringify(t);let u=`{
`;for([l,c]of Object.entries(e)){u+=`    ${p(l)}: {
`;for(var[h,y]of Object.entries(c))t&&("{\n"!==u.slice(-2)&&(u+="\n"),this.keys[h].forEach(t=>u+=`        // ${t}
`)),u+=`        ${p(h)}: ${y},
`;u+=`    },
`}return u+"}"}getCompiledTranslationsDumpAsCJSExport(t){var e=[],t=`module.exports = ${this.getCompiledTranslationsDump(t,e)};
`;return this.getDeduplicationDump(e)+t}getCompiledTranslationsDumpAsESMExport(t){var e=[],t=`export default ${this.getCompiledTranslationsDump(t,e)};
`;return this.getDeduplicationDump(e)+t}}exports.default=Generator;
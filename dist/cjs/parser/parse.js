"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=exports.PeggySyntaxError=void 0;const text_1=require("../token/text"),literal_1=require("../token/literal"),identifier_1=require("../token/identifier"),expression_1=require("../token/expression"),object_access_1=require("../token/object-access"),array_access_1=require("../token/array-access"),collapse_1=require("./collapse");function peg$padEnd(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}class PeggySyntaxError extends Error{static buildMessage(t,e){function r(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function a(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function c(t){switch(t.type){case"literal":return'"'+n(t.text)+'"';case"class":var e=t.parts.map(t=>Array.isArray(t)?a(t[0])+"-"+a(t[1]):a(t));return"["+(t.inverted?"^":"")+e+"]";case"any":return"any character";case"end":return"end of input";case"other":return t.description}}return"Expected "+function(t){var e=t.map(c);let r,n;if(e.sort(),0<e.length){for(r=1,n=1;r<e.length;r++)e[r-1]!==e[r]&&(e[n]=e[r],n++);e.length=n}switch(e.length){case 1:return e[0];case 2:return e[0]+" or "+e[1];default:return e.slice(0,-1).join(", ")+", or "+e[e.length-1]}}(t)+" but "+((t=e)?'"'+n(t)+'"':"end of input")+" found."}constructor(t,e,r,n){super(),this.message=t,this.expected=e,this.found=r,this.location=n,this.name="PeggySyntaxError","function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(this,PeggySyntaxError.prototype):this.__proto__=PeggySyntaxError.prototype,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,PeggySyntaxError)}format(r){let n="Error: "+this.message;if(this.location){let t=null,e;for(e=0;e<r.length;e++)if(r[e].grammarSource===this.location.source){t=r[e].text.split(/\r\n|\n|\r/g);break}var a,c,o,u=this.location.start,s=this.location.source+":"+u.line+":"+u.column;t?(o=this.location.end,a=peg$padEnd("",u.line.toString().length," "),c=t[u.line-1],o=u.line===o.line?o.column:c.length+1,n+="\n --\x3e "+s+"\n"+a+" |\n"+u.line+" | "+c+"\n"+a+" | "+peg$padEnd("",u.column-1," ")+peg$padEnd("",o-u.column,"^")):n+="\n at "+s}return n}}function peg$parse(s,t){const i={},R=(t=void 0!==t?t:{}).grammarSource;var e={Start:wt};let r=wt;function Z(t){return new literal_1.default(t)}function M(t,e){return new expression_1.default(t,e)}function U(t){return[t[0],...t[1]].join("")}const N=function(t){return(0,collapse_1.default)(t)},l="",T=function(){return[new text_1.default("")]},I=function(t){return new text_1.default(t)},a="{{",B=q("{{",!1),c="}}",D=q("}}",!1),G=function(t){return t},H="@",J=q("@",!1),K=function(t,e){return new identifier_1.default(e,"@"===t)},f=".",h=q(".",!1),Q=function(t){return new object_access_1.default(t)},V="[",W=q("[",!1),X="]",Y=q("]",!1),tt=function(t){return new array_access_1.default(t)},n=/^[ \t\r\n]/,o=O([" ","\t","\r","\n"],!1,!1),et={type:"any"},u="null",rt=q("null",!1),p=function(){return null},g="NULL",nt=q("NULL",!1),A="0",d=q("0",!1),at=function(){return 0},x="-",y=q("-",!1),_=/^[1-9]/,m=O([["1","9"]],!1,!1),C=/^[0-9]/,E=O([["0","9"]],!1,!1),ct=function(t){return parseInt([t[0],t[1],...t[2]].join(""),10)},ot=function(t){return parseFloat([t[0],t[1],t[2].join(""),".",t[4].join("")].join(""))},ut=function(t){return parseFloat([...t.slice(0,3),...t[3]].join(""))},b="'",st=q("'",!1),S="\\'",it=q("\\'",!1),lt=/^[^']/,ft=O(["'"],!0,!1),ht=function(t){return t.map(t=>"\\'"===t?t[1]:t).join("")},pt='"',gt=q('"',!1),j='\\"',At=q('\\"',!1),dt=/^[^"]/,xt=O(['"'],!0,!1),yt=function(t){return t.map(t=>'\\"'===t?t[1]:t).join("")},_t=/^[a-zA-Z_$]/,mt=O([["a","z"],["A","Z"],"_","$"],!1,!1),Ct=/^[a-zA-Z0-9_$]/,Et=O([["a","z"],["A","Z"],["0","9"],"_","$"],!1,!1);let w=0,P=0;const v=[{line:1,column:1}];let F=0,$=[],k=0;if(void 0!==t.startRule){if(!(t.startRule in e))throw new Error("Can't start parsing from rule \""+t.startRule+'".');r=e[t.startRule]}function q(t,e){return{type:"literal",text:t,ignoreCase:e}}function O(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function bt(t){var e=v[t];let r;if(e)return e;for(r=t-1;!v[r];)r--;for(e={line:(e=v[r]).line,column:e.column};r<t;)10===s.charCodeAt(r)?(e.line++,e.column=1):e.column++,r++;return v[t]=e}function St(t,e){var r=bt(t),n=bt(e);return{source:R,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function z(t){w<F||(w>F&&(F=w,$=[]),$.push(t))}function jt(t,e,r){return new PeggySyntaxError(PeggySyntaxError.buildMessage(t,e),t,e,r)}function wt(){let t,e,r;if(t=w,e=[],(r=(r=vt())===i?Pt():r)!==i)for(;r!==i;)e.push(r),(r=vt())===i&&(r=Pt());else e=i;return e!==i&&(P=t,e=N(e)),(t=e)===i&&(t=w,(e=l)!==i&&(P=t,e=T()),t=e),t}function Pt(){let t,e;return t=w,(e=function(){let t,e;t=w,s.length>w?(e=s.charAt(w),w++):(e=i,0===k&&z(et));e!==i&&(P=t,e=e);return t=e}())!==i&&(P=t,e=I(e)),e}function vt(){let t,e,r,n;return t=w,s.substr(w,2)===a?(e=a,w+=2):(e=i,0===k&&z(B)),t=e!==i&&L()!==i&&(r=(r=Ft())===i?$t():r)!==i&&L()!==i&&(s.substr(w,2)===c?(n=c,w+=2):(n=i,0===k&&z(D)),n!==i)?(P=t,e=G(r)):(w=t,i)}function Ft(){let t,e;return t=w,(e=(e=function(){let t,e;t=w,s.substr(w,4)===u?(e=u,w+=4):(e=i,0===k&&z(rt));e!==i&&(P=t,e=p());(t=e)===i&&(t=w,s.substr(w,4)===g?(e=g,w+=4):(e=i,0===k&&z(nt)),e!==i&&(P=t,e=p()),t=e);return t}())===i&&(e=function(){let t,e,r,n;t=w,39===s.charCodeAt(w)?(e=b,w++):(e=i,0===k&&z(st));if(e!==i){for(r=[],s.substr(w,2)===S?(n=S,w+=2):(n=i,0===k&&z(it)),n===i&&(lt.test(s.charAt(w))?(n=s.charAt(w),w++):(n=i,0===k&&z(ft)));n!==i;)r.push(n),s.substr(w,2)===S?(n=S,w+=2):(n=i,0===k&&z(it)),n===i&&(lt.test(s.charAt(w))?(n=s.charAt(w),w++):(n=i,0===k&&z(ft)));t=r!==i&&(39===s.charCodeAt(w)?(n=b,w++):(n=i,0===k&&z(st)),n!==i)?(P=t,e=ht(r)):(w=t,i)}else w=t,t=i;if(t===i)if(t=w,34===s.charCodeAt(w)?(e=pt,w++):(e=i,0===k&&z(gt)),e!==i){for(r=[],s.substr(w,2)===j?(n=j,w+=2):(n=i,0===k&&z(At)),n===i&&(dt.test(s.charAt(w))?(n=s.charAt(w),w++):(n=i,0===k&&z(xt)));n!==i;)r.push(n),s.substr(w,2)===j?(n=j,w+=2):(n=i,0===k&&z(At)),n===i&&(dt.test(s.charAt(w))?(n=s.charAt(w),w++):(n=i,0===k&&z(xt)));t=r!==i&&(34===s.charCodeAt(w)?(n=pt,w++):(n=i,0===k&&z(gt)),n!==i)?(P=t,e=yt(r)):(w=t,i)}else w=t,t=i;return t}())===i&&(e=function(){let t,e,r,n,a,c,o,u;t=w,e=w,45===s.charCodeAt(w)?(r=x,w++):(r=i,0===k&&z(y));r===i&&(r=null);if(r!==i)if(_.test(s.charAt(w))?(n=s.charAt(w),w++):(n=i,0===k&&z(m)),n!==i){for(a=[],C.test(s.charAt(w))?(c=s.charAt(w),w++):(c=i,0===k&&z(E));c!==i;)a.push(c),C.test(s.charAt(w))?(c=s.charAt(w),w++):(c=i,0===k&&z(E));if(a!==i)if(46===s.charCodeAt(w)?(c=f,w++):(c=i,0===k&&z(h)),c!==i){if(o=[],C.test(s.charAt(w))?(u=s.charAt(w),w++):(u=i,0===k&&z(E)),u!==i)for(;u!==i;)o.push(u),C.test(s.charAt(w))?(u=s.charAt(w),w++):(u=i,0===k&&z(E));else o=i;e=o!==i?r=[r,n,a,c,o]:(w=e,i)}else w=e,e=i;else w=e,e=i}else w=e,e=i;else w=e,e=i;e!==i&&(P=t,e=ot(e));if((t=e)===i){if(t=w,e=w,45===s.charCodeAt(w)?(r=x,w++):(r=i,0===k&&z(y)),(r=r===i?null:r)!==i)if(48===s.charCodeAt(w)?(n=A,w++):(n=i,0===k&&z(d)),(n=n===i?l:n)!==i)if(46===s.charCodeAt(w)?(a=f,w++):(a=i,0===k&&z(h)),a!==i){if(c=[],C.test(s.charAt(w))?(o=s.charAt(w),w++):(o=i,0===k&&z(E)),o!==i)for(;o!==i;)c.push(o),C.test(s.charAt(w))?(o=s.charAt(w),w++):(o=i,0===k&&z(E));else c=i;e=c!==i?r=[r,n,a,c]:(w=e,i)}else w=e,e=i;else w=e,e=i;else w=e,e=i;e!==i&&(P=t,e=ut(e)),t=e}return t}())===i?function(){let t,e,r,n,a,c;t=w,48===s.charCodeAt(w)?(e=A,w++):(e=i,0===k&&z(d));e!==i&&(P=t,e=at());if((t=e)===i){if(t=w,e=w,45===s.charCodeAt(w)?(r=x,w++):(r=i,0===k&&z(y)),(r=r===i?null:r)!==i)if(_.test(s.charAt(w))?(n=s.charAt(w),w++):(n=i,0===k&&z(m)),n!==i){for(a=[],C.test(s.charAt(w))?(c=s.charAt(w),w++):(c=i,0===k&&z(E));c!==i;)a.push(c),C.test(s.charAt(w))?(c=s.charAt(w),w++):(c=i,0===k&&z(E));e=a!==i?r=[r,n,a]:(w=e,i)}else w=e,e=i;else w=e,e=i;e!==i&&(P=t,e=ct(e)),t=e}return t}():e)!==i&&(P=t,e=Z(e)),e}function $t(){let t,e,r,n;if(t=w,(e=function(){let t,e,r;t=w,64===s.charCodeAt(w)?(e=H,w++):(e=i,0===k&&z(J));e===i&&(e=null);t=e!==i&&(r=Ot(),r!==i)?(P=t,e=K(e,r)):(w=t,i);return t}())!==i){for(r=[],(n=kt())===i&&(n=qt());n!==i;)r.push(n),(n=kt())===i&&(n=qt());t=r!==i?(P=t,M(e,r)):(w=t,i)}else w=t,t=i;return t}function kt(){let t,e,r,n;return t=w,e=L(),t=e!==i&&(46===s.charCodeAt(w)?(r=f,w++):(r=i,0===k&&z(h)),r!==i)&&L()!==i&&(n=Ot())!==i?(P=t,Q(n)):(w=t,i)}function qt(){let t,e,r,n,a;return t=w,e=L(),t=e!==i&&(91===s.charCodeAt(w)?(r=V,w++):(r=i,0===k&&z(W)),r!==i)&&L()!==i&&(n=(n=Ft())===i?$t():n)!==i&&L()!==i&&(93===s.charCodeAt(w)?(a=X,w++):(a=i,0===k&&z(Y)),a!==i)?(P=t,tt(n)):(w=t,i)}function L(){let t,e;for(t=[],n.test(s.charAt(w))?(e=s.charAt(w),w++):(e=i,0===k&&z(o));e!==i;)t.push(e),n.test(s.charAt(w))?(e=s.charAt(w),w++):(e=i,0===k&&z(o));return t}function Ot(){let t,e,r,n,a;if(t=w,e=w,_t.test(s.charAt(w))?(r=s.charAt(w),w++):(r=i,0===k&&z(mt)),r!==i){for(n=[],Ct.test(s.charAt(w))?(a=s.charAt(w),w++):(a=i,0===k&&z(Et));a!==i;)n.push(a),Ct.test(s.charAt(w))?(a=s.charAt(w),w++):(a=i,0===k&&z(Et));e=n!==i?r=[r,n]:(w=e,i)}else w=e,e=i;return e!==i&&(P=t,e=U(e)),e}if((e=r())!==i&&w===s.length)return e;throw e!==i&&w<s.length&&z({type:"end"}),jt($,F<s.length?s.charAt(F):null,F<s.length?St(F,F+1):St(F,F))}exports.PeggySyntaxError=PeggySyntaxError,exports.parse=peg$parse,exports.default=exports.parse;
import TextToken from"../token/text";import LiteralToken from"../token/literal";import IdentifierToken from"../token/identifier";import ExpressionToken from"../token/expression";import ObjectAccessToken from"../token/object-access";import ArrayAccessToken from"../token/array-access";import collapse from"./collapse";function peg$padEnd(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}class PeggySyntaxError extends Error{static buildMessage(t,e){function r(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function c(t){switch(t.type){case"literal":return'"'+n(t.text)+'"';case"class":var e=t.parts.map(t=>Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t));return"["+(t.inverted?"^":"")+e+"]";case"any":return"any character";case"end":return"end of input";case"other":return t.description}}return"Expected "+function(t){var e=t.map(c);let r,n;if(e.sort(),0<e.length){for(r=1,n=1;r<e.length;r++)e[r-1]!==e[r]&&(e[n]=e[r],n++);e.length=n}switch(e.length){case 1:return e[0];case 2:return e[0]+" or "+e[1];default:return e.slice(0,-1).join(", ")+", or "+e[e.length-1]}}(t)+" but "+((t=e)?'"'+n(t)+'"':"end of input")+" found."}constructor(t,e,r,n){super(),this.message=t,this.expected=e,this.found=r,this.location=n,this.name="PeggySyntaxError","function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(this,PeggySyntaxError.prototype):this.__proto__=PeggySyntaxError.prototype,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,PeggySyntaxError)}format(r){let n="Error: "+this.message;if(this.location){let t=null,e;for(e=0;e<r.length;e++)if(r[e].grammarSource===this.location.source){t=r[e].text.split(/\r\n|\n|\r/g);break}var o,c,a,u=this.location.start,s=this.location.source+":"+u.line+":"+u.column;t?(a=this.location.end,o=peg$padEnd("",u.line.toString().length," "),c=t[u.line-1],a=u.line===a.line?a.column:c.length+1,n+="\n --\x3e "+s+"\n"+o+" |\n"+u.line+" | "+c+"\n"+o+" | "+peg$padEnd("",u.column-1," ")+peg$padEnd("",a-u.column,"^")):n+="\n at "+s}return n}}function peg$parse(s,t){const i={},R=(t=void 0!==t?t:{}).grammarSource;var e={Start:jt};let r=jt;function Z(t){return new LiteralToken(t)}function I(t,e){return new ExpressionToken(t,e)}function U(t){return[t[0],...t[1]].join("")}const M=function(t){return collapse(t)},l="",N=function(){return[new TextToken("")]},q=function(t){return new TextToken(t)},o="{{",B=_("{{",!1),c="}}",D=_("}}",!1),G=function(t){return t},H="@",J=_("@",!1),K=function(t,e){return new IdentifierToken(e,"@"===t)},f=".",h=_(".",!1),Q=function(t){return new ObjectAccessToken(t)},V="[",W=_("[",!1),X="]",Y=_("]",!1),tt=function(t){return new ArrayAccessToken(t)},n=/^[ \t\r\n]/,a=L([" ","\t","\r","\n"],!1,!1),et={type:"any"},u="null",rt=_("null",!1),p=function(){return null},A="NULL",nt=_("NULL",!1),g="0",d=_("0",!1),ot=function(){return 0},m="-",x=_("-",!1),y=/^[1-9]/,k=L([["1","9"]],!1,!1),C=/^[0-9]/,E=L([["0","9"]],!1,!1),ct=function(t){return parseInt([t[0],t[1],...t[2]].join(""),10)},at=function(t){return parseFloat([t[0],t[1],t[2].join(""),".",t[4].join("")].join(""))},ut=function(t){return parseFloat([...t.slice(0,3),...t[3]].join(""))},T="'",st=_("'",!1),b="\\'",it=_("\\'",!1),lt=/^[^']/,ft=L(["'"],!0,!1),ht=function(t){return t.map(t=>"\\'"===t?t[1]:t).join("")},pt='"',At=_('"',!1),S='\\"',gt=_('\\"',!1),dt=/^[^"]/,mt=L(['"'],!0,!1),xt=function(t){return t.map(t=>'\\"'===t?t[1]:t).join("")},yt=/^[a-zA-Z_$]/,kt=L([["a","z"],["A","Z"],"_","$"],!1,!1),Ct=/^[a-zA-Z0-9_$]/,Et=L([["a","z"],["A","Z"],["0","9"],"_","$"],!1,!1);let j=0,w=0;const v=[{line:1,column:1}];let F=0,P=[],$=0;if(void 0!==t.startRule){if(!(t.startRule in e))throw new Error("Can't start parsing from rule \""+t.startRule+'".');r=e[t.startRule]}function _(t,e){return{type:"literal",text:t,ignoreCase:e}}function L(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function Tt(t){var e=v[t];let r;if(e)return e;for(r=t-1;!v[r];)r--;for(e={line:(e=v[r]).line,column:e.column};r<t;)10===s.charCodeAt(r)?(e.line++,e.column=1):e.column++,r++;return v[t]=e}function bt(t,e){var r=Tt(t),n=Tt(e);return{source:R,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function O(t){j<F||(j>F&&(F=j,P=[]),P.push(t))}function St(t,e,r){return new PeggySyntaxError(PeggySyntaxError.buildMessage(t,e),t,e,r)}function jt(){let t,e,r;if(t=j,e=[],(r=(r=vt())===i?wt():r)!==i)for(;r!==i;)e.push(r),(r=vt())===i&&(r=wt());else e=i;return e!==i&&(w=t,e=M(e)),(t=e)===i&&(t=j,(e=l)!==i&&(w=t,e=N()),t=e),t}function wt(){let t,e;return t=j,(e=function(){let t,e;t=j,s.length>j?(e=s.charAt(j),j++):(e=i,0===$&&O(et));e!==i&&(w=t,e=e);return t=e}())!==i&&(w=t,e=q(e)),e}function vt(){let t,e,r,n;return t=j,s.substr(j,2)===o?(e=o,j+=2):(e=i,0===$&&O(B)),t=e!==i&&z()!==i&&(r=(r=Ft())===i?Pt():r)!==i&&z()!==i&&(s.substr(j,2)===c?(n=c,j+=2):(n=i,0===$&&O(D)),n!==i)?(w=t,e=G(r)):(j=t,i)}function Ft(){let t,e;return t=j,(e=(e=function(){let t,e;t=j,s.substr(j,4)===u?(e=u,j+=4):(e=i,0===$&&O(rt));e!==i&&(w=t,e=p());(t=e)===i&&(t=j,s.substr(j,4)===A?(e=A,j+=4):(e=i,0===$&&O(nt)),e!==i&&(w=t,e=p()),t=e);return t}())===i&&(e=function(){let t,e,r,n;t=j,39===s.charCodeAt(j)?(e=T,j++):(e=i,0===$&&O(st));if(e!==i){for(r=[],s.substr(j,2)===b?(n=b,j+=2):(n=i,0===$&&O(it)),n===i&&(lt.test(s.charAt(j))?(n=s.charAt(j),j++):(n=i,0===$&&O(ft)));n!==i;)r.push(n),s.substr(j,2)===b?(n=b,j+=2):(n=i,0===$&&O(it)),n===i&&(lt.test(s.charAt(j))?(n=s.charAt(j),j++):(n=i,0===$&&O(ft)));t=r!==i&&(39===s.charCodeAt(j)?(n=T,j++):(n=i,0===$&&O(st)),n!==i)?(w=t,e=ht(r)):(j=t,i)}else j=t,t=i;if(t===i)if(t=j,34===s.charCodeAt(j)?(e=pt,j++):(e=i,0===$&&O(At)),e!==i){for(r=[],s.substr(j,2)===S?(n=S,j+=2):(n=i,0===$&&O(gt)),n===i&&(dt.test(s.charAt(j))?(n=s.charAt(j),j++):(n=i,0===$&&O(mt)));n!==i;)r.push(n),s.substr(j,2)===S?(n=S,j+=2):(n=i,0===$&&O(gt)),n===i&&(dt.test(s.charAt(j))?(n=s.charAt(j),j++):(n=i,0===$&&O(mt)));t=r!==i&&(34===s.charCodeAt(j)?(n=pt,j++):(n=i,0===$&&O(At)),n!==i)?(w=t,e=xt(r)):(j=t,i)}else j=t,t=i;return t}())===i&&(e=function(){let t,e,r,n,o,c,a,u;t=j,e=j,45===s.charCodeAt(j)?(r=m,j++):(r=i,0===$&&O(x));r===i&&(r=null);if(r!==i)if(y.test(s.charAt(j))?(n=s.charAt(j),j++):(n=i,0===$&&O(k)),n!==i){for(o=[],C.test(s.charAt(j))?(c=s.charAt(j),j++):(c=i,0===$&&O(E));c!==i;)o.push(c),C.test(s.charAt(j))?(c=s.charAt(j),j++):(c=i,0===$&&O(E));if(o!==i)if(46===s.charCodeAt(j)?(c=f,j++):(c=i,0===$&&O(h)),c!==i){if(a=[],C.test(s.charAt(j))?(u=s.charAt(j),j++):(u=i,0===$&&O(E)),u!==i)for(;u!==i;)a.push(u),C.test(s.charAt(j))?(u=s.charAt(j),j++):(u=i,0===$&&O(E));else a=i;e=a!==i?r=[r,n,o,c,a]:(j=e,i)}else j=e,e=i;else j=e,e=i}else j=e,e=i;else j=e,e=i;e!==i&&(w=t,e=at(e));if((t=e)===i){if(t=j,e=j,45===s.charCodeAt(j)?(r=m,j++):(r=i,0===$&&O(x)),(r=r===i?null:r)!==i)if(48===s.charCodeAt(j)?(n=g,j++):(n=i,0===$&&O(d)),(n=n===i?l:n)!==i)if(46===s.charCodeAt(j)?(o=f,j++):(o=i,0===$&&O(h)),o!==i){if(c=[],C.test(s.charAt(j))?(a=s.charAt(j),j++):(a=i,0===$&&O(E)),a!==i)for(;a!==i;)c.push(a),C.test(s.charAt(j))?(a=s.charAt(j),j++):(a=i,0===$&&O(E));else c=i;e=c!==i?r=[r,n,o,c]:(j=e,i)}else j=e,e=i;else j=e,e=i;else j=e,e=i;e!==i&&(w=t,e=ut(e)),t=e}return t}())===i?function(){let t,e,r,n,o,c;t=j,48===s.charCodeAt(j)?(e=g,j++):(e=i,0===$&&O(d));e!==i&&(w=t,e=ot());if((t=e)===i){if(t=j,e=j,45===s.charCodeAt(j)?(r=m,j++):(r=i,0===$&&O(x)),(r=r===i?null:r)!==i)if(y.test(s.charAt(j))?(n=s.charAt(j),j++):(n=i,0===$&&O(k)),n!==i){for(o=[],C.test(s.charAt(j))?(c=s.charAt(j),j++):(c=i,0===$&&O(E));c!==i;)o.push(c),C.test(s.charAt(j))?(c=s.charAt(j),j++):(c=i,0===$&&O(E));e=o!==i?r=[r,n,o]:(j=e,i)}else j=e,e=i;else j=e,e=i;e!==i&&(w=t,e=ct(e)),t=e}return t}():e)!==i&&(w=t,e=Z(e)),e}function Pt(){let t,e,r,n;if(t=j,(e=function(){let t,e,r;t=j,64===s.charCodeAt(j)?(e=H,j++):(e=i,0===$&&O(J));e===i&&(e=null);t=e!==i&&(r=Lt(),r!==i)?(w=t,e=K(e,r)):(j=t,i);return t}())!==i){for(r=[],(n=$t())===i&&(n=_t());n!==i;)r.push(n),(n=$t())===i&&(n=_t());t=r!==i?(w=t,I(e,r)):(j=t,i)}else j=t,t=i;return t}function $t(){let t,e,r,n;return t=j,e=z(),t=e!==i&&(46===s.charCodeAt(j)?(r=f,j++):(r=i,0===$&&O(h)),r!==i)&&z()!==i&&(n=Lt())!==i?(w=t,Q(n)):(j=t,i)}function _t(){let t,e,r,n,o;return t=j,e=z(),t=e!==i&&(91===s.charCodeAt(j)?(r=V,j++):(r=i,0===$&&O(W)),r!==i)&&z()!==i&&(n=(n=Ft())===i?Pt():n)!==i&&z()!==i&&(93===s.charCodeAt(j)?(o=X,j++):(o=i,0===$&&O(Y)),o!==i)?(w=t,tt(n)):(j=t,i)}function z(){let t,e;for(t=[],n.test(s.charAt(j))?(e=s.charAt(j),j++):(e=i,0===$&&O(a));e!==i;)t.push(e),n.test(s.charAt(j))?(e=s.charAt(j),j++):(e=i,0===$&&O(a));return t}function Lt(){let t,e,r,n,o;if(t=j,e=j,yt.test(s.charAt(j))?(r=s.charAt(j),j++):(r=i,0===$&&O(kt)),r!==i){for(n=[],Ct.test(s.charAt(j))?(o=s.charAt(j),j++):(o=i,0===$&&O(Et));o!==i;)n.push(o),Ct.test(s.charAt(j))?(o=s.charAt(j),j++):(o=i,0===$&&O(Et));e=n!==i?r=[r,n]:(j=e,i)}else j=e,e=i;return e!==i&&(w=t,e=U(e)),e}if((e=r())!==i&&j===s.length)return e;throw e!==i&&j<s.length&&O({type:"end"}),St(P,F<s.length?s.charAt(F):null,F<s.length?bt(F,F+1):bt(F,F))}const parse=peg$parse;export default parse;export{PeggySyntaxError,parse};
import GeneratorOptions from"./GeneratorOptions.mjs";import CRC32 from"../Util/CRC32.mjs";export default class Generator{getDeduplicationDump(s){if(0===Object.keys(s).length)return"";let e="const ";for(let t=0;t<s.length;t++)e+=(0<t?"      ":"")+this.getDeduplicationVar(t)+" = "+s[t]+",\n";return e.substring(0,e.length-2)+";\n\n"}getDeduplicationVar(t){let s="";for(;s="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"[t%52]+s,0<(t=Math.floor(t/52)););return"_"+s}constructor(t={}){this.keys={},this.options=t instanceof GeneratorOptions?t:new GeneratorOptions(t)}parse(t,s,e=!1){if(!e&&s)for(var[n,o]of Object.entries(this.keys))this.keys[n]=o.filter(t=>t.split("::")[0]!==s),0===this.keys[n].length&&delete this.keys[n];for(const i of this.options.analyzer.analyze(t,s)){this.keys.hasOwnProperty(i.key)||(this.keys[i.key]=[]);var r=this.keys[i.key];const s=`${i.source||"[inline code]"}::${i.line}:`+i.column;r.includes(i.source)||r.push(s)}return this}setTranslations(t,s){return this.options.logger.verbose(`Updating translations for locale: ${t} (dict size=${Object.keys(s).length}).`),this.options.translations[t]=s,this}mergeTranslations(t){for(var[s,e]of Object.entries(t))this.setTranslations(s,e);return this}removeTranslations(t){return this.options.translations.hasOwnProperty(t)&&(this.options.logger.verbose(`Removing translations for locale: ${t}.`),delete this.options.translations[t]),this}getTranslationsChecksum(){return CRC32.checksum(JSON.stringify(this.options.translations))}getMissingTranslationKeys(){this.options.logger.log("Generating missing translations.");var t={};for(const s of Object.keys(this.options.translations)){const e=this.options.translations[s];t[s]=Object.keys(this.keys).filter(t=>!e.hasOwnProperty(t))}return t}getUnusedTranslationKeys(){this.options.logger.log("Generating unused translations.");var t={};for(const e of Object.keys(this.options.translations)){var s=this.options.translations[e];t[e]=Object.keys(s).filter(t=>!this.keys.hasOwnProperty(t))}return t}getCompiledTranslationsDump(t,r){this.options.logger.log("Generating translation dump.");const i={};var s=Object.fromEntries(Object.keys(this.options.translations).map(t=>{const s=this.options.translations[t];var e={};for(const o of Object.keys(this.keys).filter(t=>s.hasOwnProperty(t))){var n=this.options.compiler.compile(s[o]);e[o]=n,r&&(i.hasOwnProperty(n)||(i[n]=0),i[n]++)}return[t,e]}));if(r){r.push(...Object.keys(i).filter(t=>1<i[t]));for(var[e,n]of Object.entries(s))for(var[o,a]of Object.entries(n)){a=r.indexOf(a);-1!==a&&(s[e][o]=this.getDeduplicationVar(a))}}var l,p,h=t=>t.match(/^[a-z_$][a-z0-9_$]*$/i)?t:JSON.stringify(t);let c=`{
`;for([l,p]of Object.entries(s)){c+=`    ${h(l)}: {
`;for(var[u,f]of Object.entries(p))t&&("{\n"!==c.slice(-2)&&(c+="\n"),this.keys[u].forEach(t=>c+=`        // ${t}
`)),c+=`        ${h(u)}: ${f},
`;c+=`    },
`}return c+"}"}getCompiledTranslationsDumpAsCJSExport(t){var s=[],t=`module.exports = ${this.getCompiledTranslationsDump(t,s)};
`;return this.getDeduplicationDump(s)+t}getCompiledTranslationsDumpAsESMExport(t){var s=[],t=`export default ${this.getCompiledTranslationsDump(t,s)};
`;return this.getDeduplicationDump(s)+t}}
import GeneratorOptions from"./GeneratorOptions.mjs";import CRC32 from"../Util/CRC32.mjs";export default class Generator{getDeduplicationDump(s){if(0===Object.keys(s).length)return"";let e="const ";for(let t=0;t<s.length;t++)e+=(0<t?"      ":"")+this.getDeduplicationVar(t)+" = "+s[t]+",\n";return e.substring(0,e.length-2)+";\n\n"}getDeduplicationVar(t){let s="";for(;s="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"[t%52]+s,0<(t=Math.floor(t/52)););return"_"+s}constructor(t={}){this.keys={},this.options=t instanceof GeneratorOptions?t:new GeneratorOptions(t)}parse(t,s,e=!1){if(!e&&s)for(var[r,n]of Object.entries(this.keys))this.keys[r]=n.filter(t=>t.split("::")[0]!==s),0===this.keys[r].length&&delete this.keys[r];for(const i of this.options.analyzer.analyze(t,s)){this.keys.hasOwnProperty(i.key)||(this.keys[i.key]=[]);var o=this.keys[i.key];const s=`${i.source||"[inline code]"}::${i.line}:`+i.column;o.includes(i.source)||o.push(s)}return this}setTranslations(t,s){return this.options.translations[t]=s,this}mergeTranslations(t){for(var[s,e]of Object.entries(t))this.setTranslations(s,e);return this}removeTranslations(t){return this.options.translations.hasOwnProperty(t)&&delete this.options.translations[t],this}getTranslationsChecksum(){return CRC32.checksum(JSON.stringify(this.options.translations))}getMissingTranslationKeys(){var t={};for(const s of Object.keys(this.options.translations)){const e=this.options.translations[s];t[s]=Object.keys(this.keys).filter(t=>!e.hasOwnProperty(t))}return t}getUnusedTranslationKeys(){var t={};for(const e of Object.keys(this.options.translations)){var s=this.options.translations[e];t[e]=Object.keys(s).filter(t=>!this.keys.hasOwnProperty(t))}return t}getCompiledTranslationsDump(t,o){const i={};var s=Object.fromEntries(Object.keys(this.options.translations).map(t=>{const s=this.options.translations[t];var e={};for(const n of Object.keys(this.keys).filter(t=>s.hasOwnProperty(t))){var r=this.options.compiler.compile(s[n]);e[n]=r,o&&(i.hasOwnProperty(r)||(i[r]=0),i[r]++)}return[t,e]}));if(o){o.push(...Object.keys(i).filter(t=>1<i[t]));for(var[e,r]of Object.entries(s))for(var[n,a]of Object.entries(r)){a=o.indexOf(a);-1!==a&&(s[e][n]=this.getDeduplicationVar(a))}}var l,p,h=t=>t.match(/^[a-z_$][a-z0-9_$]*$/i)?t:JSON.stringify(t);let c=`{
`;for([l,p]of Object.entries(s)){c+=`    ${h(l)}: {
`;for(var[u,f]of Object.entries(p))t&&("{\n"!==c.slice(-2)&&(c+="\n"),this.keys[u].forEach(t=>c+=`        // ${t}
`)),c+=`        ${h(u)}: ${f},
`;c+=`    },
`}return c+"}"}getCompiledTranslationsDumpAsCJSExport(t){var s=[],t=`module.exports = ${this.getCompiledTranslationsDump(t,s)};
`;return this.getDeduplicationDump(s)+t}getCompiledTranslationsDumpAsESMExport(t){var s=[],t=`export default ${this.getCompiledTranslationsDump(t,s)};
`;return this.getDeduplicationDump(s)+t}}
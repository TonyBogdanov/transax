var __awaiter=this&&this.__awaiter||function(t,a,s,h){return new(s=s||Promise)(function(i,e){function r(t){try{n(h.next(t))}catch(t){e(t)}}function o(t){try{n(h.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?i(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,o)}n((h=h.apply(t,a||[])).next())})};import{basename,extname}from"node:path";import{readFile}from"node:fs/promises";import{watch}from"chokidar";import{glob}from"glob";import PathError from"../Util/PathError.mjs";import Generator from"../Generator/Generator.mjs";import Analyzer from"../Analyzer/Analyzer.mjs";import Compiler from"../Compiler/Compiler.mjs";import PluginOptions from"./PluginOptions.mjs";export default class Plugin{filename(t){return(t=basename(t)).substring(0,t.length-extname(t).length)}flatten(t,e=[]){var i,r,o={};for([i,r]of Object.entries(t))"object"==typeof r?Object.assign(o,this.flatten(r,e.concat(i))):o[e.concat(i).join(".")]=r;return o}createWatcher(t){return watch(t,{ignoreInitial:!0,awaitWriteFinish:{stabilityThreshold:500}})}constructor(t){this.timeout=null,this.options=PathError.wrap("options",()=>new PluginOptions(t));var e={quiet:this.options.quiet,verbose:this.options.verbose};this.generator=new Generator({analyzer:new Analyzer({names:this.options.input.keywords,keyFormatter:this.options.input.keyFormatter,logger:e}),compiler:new Compiler({logger:e}),logger:e})}createDictionaryWatcher(){return this.createWatcher(this.options.dictionary.pattern)}createInputWatcher(){return this.createWatcher(this.options.input.pattern)}loadDictionaries(){glob(this.options.dictionary.pattern).then(t=>t.forEach(this.loadDictionary.bind(this)))}loadDictionary(e){return __awaiter(this,void 0,void 0,function*(){var t=yield this.options.dictionary.handler(e);this.generator.mergeTranslations(Object.fromEntries(Object.entries(t).map(t=>[t[0],this.flatten(t[1])]))),this.dump()})}removeDictionary(t){this.generator.removeTranslations(this.filename(t)),this.dump()}loadInputs(){glob(this.options.input.pattern).then(t=>t.forEach(this.loadInput.bind(this)))}loadInput(t){return __awaiter(this,void 0,void 0,function*(){this.generator.parse(yield readFile(t,"utf8"),t),this.dump()})}removeInput(t){this.generator.parse("",t),this.dump()}dump(){const{compiled:t,missing:e,unused:i}=this.options.output;clearTimeout(this.timeout),this.timeout=setTimeout(()=>__awaiter(this,void 0,void 0,function*(){t.handler(t.path,this.generator),null!==e&&void 0!==e&&e.handler(e.path,this.generator),null!==i&&void 0!==i&&i.handler(i.path,this.generator)}),500)}}
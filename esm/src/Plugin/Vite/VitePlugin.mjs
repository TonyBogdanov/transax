var __awaiter=this&&this.__awaiter||function(e,a,u,l){return new(u=u||Promise)(function(r,t){function n(e){try{i(l.next(e))}catch(e){t(e)}}function o(e){try{i(l.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(n,o)}i((l=l.apply(e,a||[])).next())})};import{basename,extname}from"node:path";import{readFile}from"node:fs/promises";import{watch}from"chokidar";import{glob}from"glob";import PathError from"../../Util/PathError.mjs";import Generator from"../../Generator/Generator.mjs";import Analyzer from"../../Analyzer/Analyzer.mjs";import Compiler from"../../Compiler/Compiler.mjs";import VitePluginOptions from"./VitePluginOptions.mjs";function filename(e){return(e=basename(e)).substring(0,e.length-extname(e).length)}function flatten(e,t=[]){var r,n,o={};for([r,n]of Object.entries(e))"object"==typeof n?Object.assign(o,flatten(n,t.concat(r))):o[t.concat(r).join(".")]=n;return o}function createWatcher(e){return watch(e,{ignoreInitial:!0,awaitWriteFinish:{stabilityThreshold:500}})}function createDumper(r,n){let e=null;return()=>new Promise(t=>{clearTimeout(e),e=setTimeout(()=>{var e;return Promise.all([n.output.compiled.handler(n.output.compiled.path,r),null!=(e=null==(e=n.output.missing)?void 0:e.handler(n.output.missing.path,r))?e:Promise.resolve(),null!=(e=null==(e=n.output.unused)?void 0:e.handler(n.output.unused.path,r))?e:Promise.resolve()]).then(()=>t())},500)})}function createDictionaryLoader(r,n,o){return t=>__awaiter(this,void 0,void 0,function*(){var e=yield n.dictionary.handler(t);return r.mergeTranslations(Object.fromEntries(Object.entries(e).map(e=>[e[0],flatten(e[1])]))),o()})}function createDictionaryRemover(t,r){return e=>__awaiter(this,void 0,void 0,function*(){return t.removeTranslations(filename(e)),r()})}function createInputLoader(t,r){return e=>__awaiter(this,void 0,void 0,function*(){return t.parse(yield readFile(e,"utf8"),e),r()})}function createInputRemover(t,r){return e=>__awaiter(this,void 0,void 0,function*(){return t.parse("",e),r()})}function createMultiLoader(t){return e=>__awaiter(this,void 0,void 0,function*(){return Promise.all(e.map(t))})}export default function VitePlugin(e){const t=PathError.wrap("options",()=>new VitePluginOptions(e));var r={quiet:t.quiet,verbose:t.verbose},r=new Generator({analyzer:new Analyzer({names:t.input.keywords,keyFormatter:t.input.keyFormatter,logger:r}),compiler:new Compiler({logger:r}),logger:r}),n=createDumper(r,t);const o=createDictionaryLoader(r,t,n),i=createMultiLoader(o),a=createDictionaryRemover(r,n),u=createInputLoader(r,n),l=createMultiLoader(u),c=createInputRemover(r,n),s=createWatcher(t.input.pattern),m=createWatcher(t.dictionary.pattern);return{name:"vite-plugin-transax",buildStart(){m.on("add",o),m.on("change",o),m.on("unlink",a),s.on("add",u),s.on("change",u),s.on("unlink",c),glob(t.dictionary.pattern).then(i),glob(t.input.pattern).then(l)},closeBundle(){return Promise.all([s.close(),m.close()])}}}
var __awaiter=this&&this.__awaiter||function(t,r,a,l){return new(a=a||Promise)(function(n,i){function s(t){try{e(l.next(t))}catch(t){i(t)}}function o(t){try{e(l.throw(t))}catch(t){i(t)}}function e(t){var i;t.done?n(t.value):((i=t.value)instanceof a?i:new a(function(t){t(i)})).then(s,o)}e((l=l.apply(t,r||[])).next())})};import{sync}from"glob";import{promises}from"fs";import{relative}from"path";import{Logger}from"./Logger";import{Analyzer}from"./Analyzer";import{Compiler}from"./Compiler";const{readFile,writeFile}=promises,isTranslationDictionary=t=>t instanceof Object&&0===Object.values(t).filter(t=>!(t instanceof Object)||0!==Object.values(t).filter(t=>"string"!=typeof t).length).length;class Options{constructor(t={}){if(this.translations={},this.loggerOptions={},this.analyzerOptions={},this.compilerOptions={},"translations"in t){if(!isTranslationDictionary(t.translations))throw new Error("Options.translations must be a TranslationDictionary.");this.translations=t.translations}if("loggerOptions"in t){if(!(t.loggerOptions instanceof Object))throw new Error("Options.loggerOptions must be an object.");this.loggerOptions=t.loggerOptions}if("analyzerOptions"in t){if(!(t.analyzerOptions instanceof Object))throw new Error("Options.analyzerOptions must be an object.");this.analyzerOptions=t.analyzerOptions}if("compilerOptions"in t){if(!(t.compilerOptions instanceof Object))throw new Error("Options.compilerOptions must be an object.");this.compilerOptions=t.compilerOptions}}}class Generator{constructor(t={}){this.keys={},this.options=t instanceof Options?t:new Options(t),this.logger=new Logger("Generator",this.options.loggerOptions),this.analyzer=new Analyzer(this.options.analyzerOptions),this.compiler=new Compiler(this.options.compilerOptions)}parseContent(n,s){return __awaiter(this,void 0,void 0,function*(){for(const i of this.analyzer.analyze(n,s?relative(process.cwd(),s):void 0)){this.keys.hasOwnProperty(i.key)||(this.keys[i.key]=[]);var t=this.keys[i.key];const s=`${i.source||"[inline code]"}::${i.line}:`+i.column;t.includes(i.source)||t.push(s)}return this})}parseFile(t){return __awaiter(this,void 0,void 0,function*(){return yield this.parseContent((yield readFile(t)).toString("utf-8"),t),this})}parseGlob(t){return __awaiter(this,void 0,void 0,function*(){return yield Promise.all(sync(t).map(t=>this.parseFile(t))),this})}getMissingTranslationKeys(){var t={};for(const i of Object.keys(this.options.translations)){const n=this.options.translations[i];t[i]=Object.keys(this.keys).filter(t=>!n.hasOwnProperty(t))}return t}getUnusedTranslationKeys(){var t={};for(const n of Object.keys(this.options.translations)){var i=this.options.translations[n];t[n]=Object.keys(i).filter(t=>!this.keys.hasOwnProperty(t))}return t}getCompiledTranslationsDump(){var t=t=>t.match(/^[a-z_$][a-z0-9_$]*$/i)?t:JSON.stringify(t);let i=`{
`;for(const n of Object.keys(this.options.translations)){const s=this.options.translations[n];i+=`    ${t(n)}: {
`;for(const o of Object.keys(this.keys).filter(t=>s.hasOwnProperty(t)))i+=`        ${t(o)}: ${this.compiler.compile(s[o])},
`;i+=`    },
`}return i+"}"}getCompiledTranslationsDumpAsCJSExport(){return`module.exports = ${this.getCompiledTranslationsDump()};
`}getCompiledTranslationsDumpAsESMExport(){return`export default ${this.getCompiledTranslationsDump()};
`}dumpMissingTranslationKeysAsJSON(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,JSON.stringify(this.getMissingTranslationKeys(),null,2))})}dumpUnusedTranslationKeysAsJSON(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,JSON.stringify(this.getUnusedTranslationKeys(),null,2))})}dumpCompiledTranslationsForCJS(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,this.getCompiledTranslationsDumpAsCJSExport())})}dumpCompiledTranslationsForESM(t){return __awaiter(this,void 0,void 0,function*(){yield writeFile(t,this.getCompiledTranslationsDumpAsESMExport())})}}export{Options,Generator};
import{Logger}from"./Logger";function peg$padEnd(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}class PeggySyntaxError extends Error{static buildMessage(t,e){function r(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,t=>"\\x0"+r(t)).replace(/[\x10-\x1F\x7F-\x9F]/g,t=>"\\x"+r(t))}function s(t){switch(t.type){case"literal":return'"'+n(t.text)+'"';case"class":var e=t.parts.map(t=>Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t));return"["+(t.inverted?"^":"")+e+"]";case"any":return"any character";case"end":return"end of input";case"other":return t.description}}return"Expected "+function(t){var e=t.map(s);let r,n;if(e.sort(),0<e.length){for(r=1,n=1;r<e.length;r++)e[r-1]!==e[r]&&(e[n]=e[r],n++);e.length=n}switch(e.length){case 1:return e[0];case 2:return e[0]+" or "+e[1];default:return e.slice(0,-1).join(", ")+", or "+e[e.length-1]}}(t)+" but "+((t=e)?'"'+n(t)+'"':"end of input")+" found."}constructor(t,e,r,n){super(),this.message=t,this.expected=e,this.found=r,this.location=n,this.name="PeggySyntaxError","function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(this,PeggySyntaxError.prototype):this.__proto__=PeggySyntaxError.prototype,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,PeggySyntaxError)}format(r){let n="Error: "+this.message;if(this.location){let t=null,e;for(e=0;e<r.length;e++)if(r[e].grammarSource===this.location.source){t=r[e].text.split(/\r\n|\n|\r/g);break}var o,s,a,i=this.location.start,c=this.location.source+":"+i.line+":"+i.column;t?(a=this.location.end,o=peg$padEnd("",i.line.toString().length," "),s=t[i.line-1],a=i.line===a.line?a.column:s.length+1,n+="\n --\x3e "+c+"\n"+o+" |\n"+i.line+" | "+s+"\n"+o+" | "+peg$padEnd("",i.column-1," ")+peg$padEnd("",a-i.column,"^")):n+="\n at "+c}return n}}function peg$parse(a,t){const i={},R=(t=void 0!==t?t:{}).grammarSource;var e={Start:at};let r=at;function L(t){return t.map(t=>"\\'"===t?t[1]:t).join("")}function M(t){return t.map(t=>'\\"'===t?t[1]:t).join("")}function U(t){return t.map(([,t])=>"\\`"===t?t[1]:t).join("")}const q=function(t){return t.flat().filter(t=>t instanceof Token)},B="(",D=P("(",!1),G=/^[,)]/,H=j([",",")"],!1,!1),I=function(t,e){return new Token(t,e,rt(),nt().start.line,nt().start.column)},n=/^[ \t\r\n]/,o=j([" ","\t","\r","\n"],!1,!1),J=/^[^a-zA-Z_$]/,K=j([["a","z"],["A","Z"],"_","$"],!0,!1),N={type:"any"},Q=/^[a-zA-Z_$]/,V=j([["a","z"],["A","Z"],"_","$"],!1,!1),s=/^[a-zA-Z_$0-9]/,c=j([["a","z"],["A","Z"],"_","$",["0","9"]],!1,!1),W=rt,l="'",u=P("'",!1),h="\\'",g=P("\\'",!1),p=/^[^']/,f=j(["'"],!0,!1),A='"',m=P('"',!1),d='\\"',y=P('\\"',!1),x=/^[^"]/,$=j(['"'],!0,!1),b="`",E=P("`",!1),O="${",X=P("${",!1),S="\\`",Y=P("\\`",!1),tt=/^[^`]/,et=j(["`"],!0,!1);let v=0,w=0;const C=[{line:1,column:1}];let k=0,z=[],_=0;if(void 0!==t.startRule){if(!(t.startRule in e))throw new Error("Can't start parsing from rule \""+t.startRule+'".');r=e[t.startRule]}function rt(){return a.substring(w,v)}function nt(){return F(w,v)}function P(t,e){return{type:"literal",text:t,ignoreCase:e}}function j(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function ot(t){var e=C[t];let r;if(e)return e;for(r=t-1;!C[r];)r--;for(e={line:(e=C[r]).line,column:e.column};r<t;)10===a.charCodeAt(r)?(e.line++,e.column=1):e.column++,r++;return C[t]=e}function F(t,e){var r=ot(t),n=ot(e);return{source:R,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function T(t){v<k||(v>k&&(k=v,z=[]),z.push(t))}function st(t,e,r){return new PeggySyntaxError(PeggySyntaxError.buildMessage(t,e),t,e,r)}function at(){let t,e,r,n,o;for(t=v,e=[],r=v,(n=ct())===i&&(n=null),(r=n!==i&&(o=it())!==i?n=[n,o]:(v=r,i))===i&&(r=lt());r!==i;)e.push(r),r=v,(n=ct())===i&&(n=null),(r=n!==i&&(o=it())!==i?n=[n,o]:(v=r,i))===i&&(r=lt());return e!==i&&(w=t,e=q(e)),e}function it(){let t,e,r,n,o;return t=v,e=function(){let t,e,r,n;t=v,Q.test(a.charAt(v))?(e=a.charAt(v),v++):(e=i,0===_&&T(V));if(e!==i){for(r=[],s.test(a.charAt(v))?(n=a.charAt(v),v++):(n=i,0===_&&T(c));n!==i;)r.push(n),s.test(a.charAt(v))?(n=a.charAt(v),v++):(n=i,0===_&&T(c));t=r!==i?(w=t,e=W()):(v=t,i)}else v=t,t=i;return t}(),t=e!==i&&Z()!==i&&(40===a.charCodeAt(v)?(r=B,v++):(r=i,0===_&&T(D)),r!==i)&&Z()!==i&&(n=function(){let t,e,r,n,o,s;t=v,39===a.charCodeAt(v)?(e=l,v++):(e=i,0===_&&T(u));if(e!==i){for(r=[],a.substr(v,2)===h?(n=h,v+=2):(n=i,0===_&&T(g)),n===i&&(p.test(a.charAt(v))?(n=a.charAt(v),v++):(n=i,0===_&&T(f)));n!==i;)r.push(n),a.substr(v,2)===h?(n=h,v+=2):(n=i,0===_&&T(g)),n===i&&(p.test(a.charAt(v))?(n=a.charAt(v),v++):(n=i,0===_&&T(f)));t=r!==i&&(39===a.charCodeAt(v)?(n=l,v++):(n=i,0===_&&T(u)),n!==i)?(w=t,e=L(r)):(v=t,i)}else v=t,t=i;if(t===i){if(t=v,34===a.charCodeAt(v)?(e=A,v++):(e=i,0===_&&T(m)),e!==i){for(r=[],a.substr(v,2)===d?(n=d,v+=2):(n=i,0===_&&T(y)),n===i&&(x.test(a.charAt(v))?(n=a.charAt(v),v++):(n=i,0===_&&T($)));n!==i;)r.push(n),a.substr(v,2)===d?(n=d,v+=2):(n=i,0===_&&T(y)),n===i&&(x.test(a.charAt(v))?(n=a.charAt(v),v++):(n=i,0===_&&T($)));t=r!==i&&(34===a.charCodeAt(v)?(n=A,v++):(n=i,0===_&&T(m)),n!==i)?(w=t,e=M(r)):(v=t,i)}else v=t,t=i;if(t===i)if(t=v,96===a.charCodeAt(v)?(e=b,v++):(e=i,0===_&&T(E)),e!==i){for(r=[],n=v,o=v,_++,a.substr(v,2)===O?(s=O,v+=2):(s=i,0===_&&T(X)),_--,o=s===i?void 0:(v=o,i),n=o!==i&&(a.substr(v,2)===S?(s=S,v+=2):(s=i,0===_&&T(Y)),s===i&&(tt.test(a.charAt(v))?(s=a.charAt(v),v++):(s=i,0===_&&T(et))),s!==i)?o=[o,s]:(v=n,i);n!==i;)r.push(n),n=v,o=v,_++,a.substr(v,2)===O?(s=O,v+=2):(s=i,0===_&&T(X)),_--,o=s===i?void 0:(v=o,i),n=o!==i&&(a.substr(v,2)===S?(s=S,v+=2):(s=i,0===_&&T(Y)),s===i&&(tt.test(a.charAt(v))?(s=a.charAt(v),v++):(s=i,0===_&&T(et))),s!==i)?o=[o,s]:(v=n,i);t=r!==i&&(96===a.charCodeAt(v)?(n=b,v++):(n=i,0===_&&T(E)),n!==i)?(w=t,e=U(r)):(v=t,i)}else v=t,t=i}return t}())!==i&&Z()!==i&&(G.test(a.charAt(v))?(o=a.charAt(v),v++):(o=i,0===_&&T(H)),o!==i)?(w=t,I(e,n)):(v=t,i)}function Z(){let t,e;for(t=[],n.test(a.charAt(v))?(e=a.charAt(v),v++):(e=i,0===_&&T(o));e!==i;)t.push(e),n.test(a.charAt(v))?(e=a.charAt(v),v++):(e=i,0===_&&T(o));return t}function ct(){let t;return J.test(a.charAt(v))?(t=a.charAt(v),v++):(t=i,0===_&&T(K)),t}function lt(){let t;return a.length>v?(t=a.charAt(v),v++):(t=i,0===_&&T(N)),t}if((e=r())!==i&&v===a.length)return e;throw e!==i&&v<a.length&&T({type:"end"}),st(z,k<a.length?a.charAt(k):null,k<a.length?F(k,k+1):F(k,k))}const parse=peg$parse;class Token{constructor(t,e,r,n,o,s){this.name=t,this.key=e,this.text=r,this.line=n,this.column=o,this.source=s}}class Options{constructor(t={}){if(this.names=["$t"],this.loggerOptions={},"names"in t){if(!Array.isArray(t.names)||0<t.names.filter(t=>"string"!=typeof t).length)throw new Error("Options.names must be an array of strings.");this.names=t.names}if("loggerOptions"in t){if(!(t.loggerOptions instanceof Object))throw new Error("Options.loggerOptions must be an object.");this.loggerOptions=t.loggerOptions}}}class Analyzer{constructor(t={}){this.options=t instanceof Options?t:new Options(t),this.logger=new Logger("Analyzer",this.options.loggerOptions)}skip(t,e){this.logger.verbose(`Skipping ${t.text} because: "${t.name}" isn't in the list of allowed names `+(e?`in: ${e}::${t.line}:${t.column}.`:`at: ${t.line}:${t.column}.`))}analyze(t,e){this.logger.log(`Analyzing: ${e||"[inline code]"}.`);var r=[];for(const n of parse(t))-1===this.options.names.indexOf(n.name)?this.skip(n,e):(n.source=e,r.push(n));return r}}export{Token,Options,Analyzer};